var ABMCanvas=function(a,b,c,d){function v(){h=0,u=.45,j=[],a.addEventListener("mousedown",w,!1),a.addEventListener("touchstart",x,!1),window.addEventListener("mousemove",B,!1),a.addEventListener("touchmove",C,!1)}function w(b){var c=a.getBoundingClientRect();n=(b.clientX-c.left)*(a.width/c.width),o=(b.clientY-c.top)*(a.height/c.height),y(n,o,b)}function x(b){var c=a.getBoundingClientRect();n=(b.touches[0].clientX-c.left)*(a.width/c.width),o=(b.touches[0].clientY-c.top)*(a.height/c.height),y(n,o,b)}function y(b,c,d){var e;for(e=0;e<h;e++)E(j[e],b,c)&&(m=!0,k=e,l=j[e].type);return m?(j.push(j.splice(k,1)[0]),p=b-j[h-1].x,q=c-j[h-1].y,s=b-p,t=c-q,r=setInterval(z,1e3/30),b4j_raiseEvent("page_parseevent",{eventname:j[h-1].canvasid+"_objectdown",eventparams:"objectid",objectid:j[h-1].id})):h>0&&b4j_raiseEvent("page_parseevent",{eventname:j[h-1].canvasid+"_canvasdown",eventparams:"x,y",x:parseInt(b,10),y:parseInt(c,10)}),a.removeEventListener("mousedown",w,!1),a.removeEventListener("touchstart",x,!1),window.addEventListener("mouseup",A,!1),window.addEventListener("touchend",A,!1),d.preventDefault?d.preventDefault():d.returnValue&&(d.returnValue=!1),!1}function z(){j[h-1].x=j[h-1].x+u*(s-j[h-1].x),j[h-1].y=j[h-1].y+u*(t-j[h-1].y),!m&&Math.abs(j[h-1].x-s)<.1&&Math.abs(j[h-1].y-t)<.1&&(j[h-1].x=s,j[h-1].y=t,clearInterval(r)),F()}function A(b){a.addEventListener("mousedown",w,!1),a.addEventListener("touchstart",x,!1),window.removeEventListener("mouseup",A,!1),window.removeEventListener("touchend",A,!1),m?(m=!1,b4j_raiseEvent("page_parseevent",{eventname:j[h-1].canvasid+"_objectup",eventparams:"objectid",objectid:j[h-1].id})):h>0&&b4j_raiseEvent("page_parseevent",{eventname:j[h-1].canvasid+"_canvasup",eventparams:"x,y",x:parseInt(n,10),y:parseInt(o,10)})}function B(b){var c=a.getBoundingClientRect();n=(b.clientX-c.left)*(a.width/c.width),o=(b.clientY-c.top)*(a.height/c.height),D(n,o)}function C(b){var c=a.getBoundingClientRect();n=(b.touches[0].clientX-c.left)*(a.width/c.width),o=(b.touches[0].clientY-c.top)*(a.height/c.height),D(n,o)}function D(b,c){var d=!1;for(i=0;i<h;i++)if(E(j[i],b,c)){a.style.cursor="pointer",d=!0;break}if(d||(a.style.cursor="default"),m){var e,f,g,k,n,o,r;if(0==l?(k=0,n=a.width-j[h-1].width,o=0,r=a.height-j[h-1].height):(g=j[h-1].rad,k=g,n=a.width-g,o=g,r=a.height-g),e=b-p,e=e<k?k:e>n?n:e,f=c-q,f=f<o?o:f>r?r:f,j[h-1].draggableW>0){var u=j[h-1].draggableL,v=j[h-1].draggableT,w=u+j[h-1].draggableW,x=v+j[h-1].draggableH;e=e<u?u:e>w?w:e,f=f<v?v:f>x?x:f}s=e,t=f}}function E(a,b,c){if(a.draggable){if(0==a.type)return b>a.x&&b<a.x+a.width&&c>a.y&&c<a.y+a.height;var d=b-a.x,e=c-a.y,f=d*d+e*e<a.rad*a.rad;return f}return!1}function F(){b.setTransform(1,0,0,1,0,0),"transparent"==c?b.clearRect(0,0,f,g):(b.fillStyle=c,b.fillRect(0,0,f,g));var a;for(h=j.length,a=0;a<h;a++)for(var d=j[a],e=d.x,i=d.y,k=d.commands,l=0;l<k.length;l++){var m=k[l];switch(m[0]){case 1:b.fillStyle=m[1];break;case 2:for(var n=b.createLinearGradient(m[1]+e,m[2]+i,m[3]+e,m[4]+i),o=0;o<m[5].length;o++)n.addColorStop(m[5][o],m[6][o]);b.fillStyle=n;break;case 3:for(var n=b.createRadialGradient(m[1]+e,m[2]+i,m[3],m[4]+e,m[5]+i,m[6]),o=0;o<m[7].length;o++)n.addColorStop(m[7][o],m[8][o]);b.fillStyle=n;break;case 4:b.strokeStyle=m[1];break;case 5:for(var n=b.createLinearGradient(m[1]+e,m[2]+i,m[3]+e,m[4]+i),o=0;o<m[5].length;o++)n.addColorStop(m[5][o],m[6][o]);b.strokeStyle=n;break;case 6:for(var n=b.createRadialGradient(m[1]+e,m[2]+i,m[3],m[4]+e,m[5]+i,m[6]),o=0;o<m[7].length;o++)n.addColorStop(m[7][o],m[8][o]);b.strokeStyle=n;break;case 7:content.shadowBlur=m[1];break;case 8:content.shadowColor=m[1];break;case 9:b.shadowOffsetX=m[1];break;case 10:b.shadowOffsetY=m[1];break;case 11:b.lineCap=m[1];break;case 12:b.lineJoin=m[1];break;case 13:b.lineWidth=m[1];break;case 14:b.miterLimit=m[1];break;case 15:b.rect(m[1]+e,m[2]+i,m[3],m[4]);break;case 16:b.fillRect(m[1]+e,m[2]+i,m[3],m[4]);break;case 17:b.strokeRect(m[1]+e,m[2]+i,m[3],m[4]);break;case 18:b.clearRect(m[1]+e,m[2]+i,m[3],m[4]);break;case 19:b.fill();break;case 20:b.stroke();break;case 21:b.beginPath();break;case 22:b.moveTo(m[1]+e,m[2]+i);break;case 23:b.closePath();break;case 24:b.lineTo(m[1]+e,m[2]+i);break;case 25:b.clip();break;case 26:b.quadraticCurveTo(m[1]+e,m[2]+i,m[3]+e,m[4]+i);break;case 27:b.bezierCurveTo(m[1]+e,m[2]+i,m[3]+e,m[4]+i,m[5]+e,m[6]+i);break;case 28:b.arc(m[1]+e,m[2]+i,m[3],m[4],m[5]);break;case 29:b.arcTo(m[1]+e,m[2]+i,m[3]+e,m[4]+i,m[5]);break;case 30:b.scale(m[1],m[2]);break;case 31:b.rotate(m[1]);break;case 32:b.translate(m[1],m[2]);break;case 33:b.transform(m[1],m[2],m[3],m[4],m[5],m[6]);break;case 34:b.setTransform(m[1],m[2],m[3],m[4],m[5],m[6]);break;case 35:b.font=m[1];break;case 36:b.textAlign=m[1];break;case 37:b.textBaseline=m[1];break;case 38:b.fillText(m[1],m[2]+e,m[3]+i,m[4]);break;case 39:b.strokeText(m[1],m[2]+e,m[3]+i,m[4]);break;case 40:images[m[1]]?images[m[1]].complete&&b.drawImage(images[m[1]],m[2]+e,m[3]+i):console.log("image '"+m[1]+"' must be loaded in BuildPage()!");break;case 41:images[m[1]]?images[m[1]].complete&&b.drawImage(images[m[1]],m[2]+e,m[3]+i,m[4],m[5]):console.log("image '"+m[1]+"' must be loaded in BuildPage()!");break;case 42:images[m[1]]?images[m[1]].complete&&b.drawImage(images[m[1]],m[2],m[3],m[4],m[5],m[6]+e,m[7]+i,m[8],m[9]):console.log("image '"+m[1]+"' must be loaded in BuildPage()!");break;case 43:b.globalAlpha=m[1];break;case 44:b.globalCompositeOperation=m[1];break;case 45:b.save();break;case 46:b.restore();break;case 47:b.arc(m[1]+e,m[2]+i,m[3],m[4],m[5],m[6])}}}this.context=b,this.theCanvas=a;var c=c,f=a.width,g=a.height;v();var h,j,k,l,m,n,o,p,q,r,s,t,u;this.updatecanvas=function(a,b){for(var c=0;c<a.length;c++){var e,d=a[c];switch(d[0]){case"0":e=0==d[2]?{type:0,id:d[1],x:d[5],y:d[6],width:d[7],height:d[8],draggable:d[10],draggableL:d[11],draggableT:d[12],draggableW:d[13],draggableH:d[14],commands:d[15],canvasid:d[16]}:{type:1,id:d[1],x:d[5],y:d[6],rad:d[9],draggable:d[10],draggableL:d[11],draggableT:d[12],draggableW:d[13],draggableH:d[14],commands:d[15],canvasid:d[16]},j.push(e),h=j.length;break;case"1":for(i=0;i<h;i++)if(j[i].id==d[1]){d[3]&&(j[i].x=d[5]),d[4]&&(j[i].y=d[6]),j[i].commands=d[15];break}break;case"2":for(i=0;i<h;i++)if(j[i].id==d[1]){j.splice(i,1);break}h=j.length}b&&F()}},this.getposition=function(a){var b;for(b=0;b<h;b++)if(j[b].id==a)return j[b].x+";"+j[b].y;return""},this.drawcanvas=function(){F()}};